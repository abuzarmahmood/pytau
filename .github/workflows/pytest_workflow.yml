name: Pytest

on:
  pull_request:
    paths:
      - '**.py'
      - '**.ipynb'
      - 'pyproject.toml'
      - 'setup.py'
      - 'requirements*.txt'
      - '.github/workflows/pytest_workflow.yml'

jobs:
  test-primary:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    - name: Run tests
      run: |
        pytest --cov=pytau -v --tb=short --junitxml=test-results-ubuntu-latest-3.11.xml
    - name: Run notebook tests
      run: |
        # Try to run notebooks with nbmake (should now work with dummy matplotlib)
        echo "Testing model notebooks..."
        pytest --nbmake pytau/how_to/model_notebooks/ -v --tb=short --junitxml=notebook-test-results-ubuntu-latest-3.11.xml

        # Test notebook structure without execution
        pytest tests/test_how_to_notebooks.py -v

        echo "Testing how-to notebooks..."
        pytest --nbmake pytau/how_to/notebooks/ -v --tb=short

        echo "Notebook testing completed"
      shell: bash
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-ubuntu-latest-3.11
        path: |
          test-results-ubuntu-latest-3.11.xml
          notebook-test-results-ubuntu-latest-3.11.xml

  test-matrix:
    needs: test-primary
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11']
        exclude:
          - os: ubuntu-latest
            python-version: '3.11'
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    - name: Run tests
      run: |
        pytest --cov=pytau -v --tb=short --junitxml=test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml
    - name: Run notebook tests
      run: |
        # Try to run notebooks with nbmake (should now work with dummy matplotlib)
        echo "Testing model notebooks..."
        pytest --nbmake pytau/how_to/model_notebooks/ -v --tb=short --junitxml=notebook-test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml

        # Test notebook structure without execution
        pytest tests/test_how_to_notebooks.py -v

        echo "Testing how-to notebooks..."
        pytest --nbmake pytau/how_to/notebooks/ -v --tb=short

        echo "Notebook testing completed"
      shell: bash
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml
          notebook-test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml

  test-summary:
    needs: [test-primary, test-matrix]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        path: test-results
        pattern: test-results-*
        merge-multiple: true
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies for test summary
      run: |
        python -m pip install --upgrade pip
        pip install junitparser
    - name: Generate test summary
      run: |
        python .github/scripts/generate_test_summary.py
    - name: Upload test summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: |
          test_summary.md
          test_results_table.md
